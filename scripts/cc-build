#!/bin/bash
#
# cc-build - Build wrapper script for Command Center
#
# Usage: cc-build <build-command> [args...]
#
# Automatically tracks build status for the current branch by:
# 1. Detecting current git branch
# 2. Recording build start time
# 3. Running the build command
# 4. Capturing exit code
# 5. Updating build status via `ccc build update`
# 6. Preserving original exit code

set -o pipefail

# Check arguments
if [ $# -lt 1 ]; then
    echo "Usage: cc-build <build-command> [args...]" >&2
    echo "" >&2
    echo "Examples:" >&2
    echo "  cc-build npm run build" >&2
    echo "  cc-build python -m build" >&2
    echo "  cc-build go build ./..." >&2
    exit 1
fi

# Auto-detect current branch
BRANCH_NAME=$(git branch --show-current 2>/dev/null)

if [ -z "$BRANCH_NAME" ]; then
    echo "Error: Not in a git repository or not on a branch" >&2
    exit 1
fi

# Record start time
START=$(date +%s)

# Run the build command
# Capture both stdout/stderr and exit code
set +e
"$@"
EXIT_CODE=$?
set -e

# Record end time and calculate duration
END=$(date +%s)
DURATION=$((END - START))

# Determine status
if [ $EXIT_CODE -eq 0 ]; then
    STATUS="passing"
else
    STATUS="failing"
fi

# Update build status
ccc build update "$BRANCH_NAME" --status "$STATUS" --duration "$DURATION" 2>/dev/null || {
    echo "Warning: Failed to update build status for branch '$BRANCH_NAME'" >&2
}

# Exit with original exit code
exit $EXIT_CODE
